const EventEmitter=require("event-emitter-object"),kit=require("@basekits/core"),kitType=require("@basekits/kit-type"),kitObject=require("@basekits/kit-object"),LocalStoragePro=require("local-storage-pro");function Navigation(a,b){EventEmitter.call(this,a),this.id=b.id,this.views=null,this.defaultViewID=b.defaultView||"start",this.defaultLocale=b.defaultLocale||null,this.basePath=b.basePath||"/",this.viewsAreStaticByDefault=!b.hasOwnProperty("viewsAreStaticByDefault")||b.viewsAreStaticByDefault,this.ignoreLocalePathForDefaultLocale=!b.hasOwnProperty("ignoreLocalePathForDefaultLocale")||b.ignoreLocalePathForDefaultLocale,this.manipulateAddressBar=!!b.hasOwnProperty("manipulateAddressBar")&&b.manipulateAddressBar,this.isLocalFilesystem="file:"==window.location.protocol,this.foundLocales=[],this.history=[],this.storeKeyPrefix="VIEWER_"+b.id.toUpperCase()+"_",this.kit=kit,this.kit.addKit(kitType),this.kit.addKit(kitObject)}Navigation.prototype=Object.create(EventEmitter.prototype),Navigation.prototype.constructor=Navigation,Navigation.prototype.browserStore=new LocalStoragePro,Navigation.prototype.build=function(a,b,c,d){const e=this;if(!e.kit.isArray(a)&&e.kit.isEmpty(a))return;if(!e.kit.isObject(b))return;const f=e.kit.isArray(c)?c:[],g=e.kit.getProp(d,"locale",e.defaultLocale),h=[],j=a.length;for(let k=0;k<j;k++){const c=a[k],d=e.kit.getProp(c,"id"),i=e.kit.getProp(c,"component",d),j=e.kit.getProp(b,i);if(!e.kit.isEmpty(d)&&j){const a={id:d,component:j,static:e.kit.getProp(c,"static",e.viewsAreStaticByDefault),pathName:e.kit.getProp(c,"pathName",""),parent:e.kit.getProp(c,"parent",null),authRequired:e.kit.getProp(c,"authRequired",!1),metadata:e.kit.getProp(c,"metadata",{}),locale:e.kit.getProp(c,"locale",g)};0<f.length&&(a.additionalProps=f.reduce(function(a,b){return a[b]=e.kit.getProp(c,b,null),a},{})),-1===e.foundLocales.indexOf(a.locale)&&e.foundLocales.push(a.locale),h.push(a)}}const k=[],l=h.length;for(let f=0;f<l;f++){const a=h[f],b=[a.id],c=[a.pathName];for(let d=a.parent;!e.kit.isEmpty(d);){const a=h.filter(a=>a.id==d&&a.locale==g);if(e.kit.isEmpty(a))break;const f=a[0];c.push(f.pathName),b.push(f.id),d=f.parent}!e.kit.isEmpty(e.defaultLocale)&&e.defaultLocale!=a.locale&&e.ignoreLocalePathForDefaultLocale&&c.push(a.locale.toLowerCase()),a.roots=b,a.fullpath=e.basePath+c.filter(a=>0<a.length).reverse().join("/"),k.push(a)}return e.views=[].concat(k),e},Navigation.prototype.matchPath=function(a){const b=this,c=b.getViewByID(b.defaultViewID),d=b.browserStore.getItem(b.storeKeyPrefix+"RESTORE_VIEW_ID");if(!b.kit.isEmpty(d)){const a=b.getViewByID(d);if(b.browserStore.removeItem(b.storeKeyPrefix+"RESTORE_VIEW_ID"),a)return a}let e=null;if(!b.kit.isEmpty(a))e=a;else if(b.useAddressBar())try{const a=new URL(window.location.href);e=a.pathname}catch(a){}else e=b.browserStore.getItem(b.storeKeyPrefix+"ACTIVE_PATH");if(b.kit.isEmpty(e))return c;const f=e.split("/"),g=f.filter(a=>0<a.length).join("/"),h=b.basePath+g,j=b.views.length;for(let c=0;c<j;c++){const a=b.views[c];if(h==a.fullpath)return a;if(!b.kit.isEmpty(b.defaultLocale)&&b.defaultLocale==a.locale&&b.ignoreLocalePathForDefaultLocale){const c=b.basePath+b.defaultLocale+"/"+g;if(c==a.fullpath)return a}}return c},Navigation.prototype.getViewByID=function(a,b){const c=this,d=c.views.filter(function(d){return c.kit.isEmpty(b)?c.kit.isEmpty(c.defaultLocale)?d.id==a:d.id==a&&d.locale==c.defaultLocale:d.id==a&&d.locale==b});return c.kit.isEmpty(d)?void 0:d[0]},Navigation.prototype.shift=function(a,b){const c=this;if(!c.kit.isString(a))return;const d=c.getActiveView(),e=c.kit.isEmpty(b)?c.kit.getProp(d,"locale",c.defaultLocale):b,f=c.getViewByID(a,e);if(!c.kit.isEmpty(f)){if(c.emit("beforeShift",[d,f]),c.history.unshift(f),c.useAddressBar())try{window.history.pushState(null,null,f.fullpath)}catch(a){}const a=c.getActiveView();return c.browserStore.setItem(c.storeKeyPrefix+"ACTIVE_PATH",a.fullpath),c.emit("afterShift",[a,c.getPrevView()]),c.kit.isEmpty(d)&&c.emit("initialShift",[a]),!0}},Navigation.prototype.useAddressBar=function(){return!0===this.manipulateAddressBar&&!1===this.isLocalFilesystem},Navigation.prototype.getActiveView=function(){return 0<this.history.length?this.history[0]:null},Navigation.prototype.getPrevView=function(){return 1<this.history.length?this.history[1]:null},Navigation.prototype.getLink=function(a,b,c){const d=this;if(!d.kit.isString(a))return;const e=!d.kit.isEmpty(b)&&d.kit.isString(b)?b:"",f=d.kit.isEmpty(c)?d.getActiveView().locale:c,g=d.getViewByID(a,f);return d.kit.isEmpty(g)?void 0:e+g.fullpath},Navigation.prototype.findAlternates=function(a,b){const c=this;if(!c.kit.isString(a)||c.kit.isEmpty(c.defaultLocale))return[];const d=c.kit.isEmpty(b)?"":b,e=c.views.filter(b=>b.id==a);if(c.kit.isEmpty(e))return[];/[-_]/;return e.map(function(a){return{lang:a.locale,url:d+a.fullpath}})},Navigation.prototype.genHierarchicalMap=function(a,b){function c(a){const b=d.views.filter(b=>b.parent==a.id&&b.locale==e);return a.children=d.kit.isEmpty(b)?[]:b.map(a=>c(a)),a}const d=this,e=d.kit.isEmpty(b)?d.getActiveView().locale:b;return d.views.filter(b=>b.locale==e&&(d.kit.isEmpty(a)?d.kit.isEmpty(b.parent):b.parent==a)).map(a=>c(a))},Navigation.prototype.breadcrumb=function(a,b){const c=this;return a.roots.reverse().map(function(d){const e=c.getViewByID(d,a.locale);return{url:b+e.fullpath,title:e.metadata.title}})},module.exports=Navigation;