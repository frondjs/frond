const StateManagerObject=require("state-manager-object/source"),FrondComponent=require("./component"),Network=require("./network"),frondTags=require("./frondTags"),svgTags=require("./svgTags"),htmlTags=require("./htmlTags"),viewerRenderFn=require("./navigation/renderFn"),ff=require("./core/ff"),errMsgs={invalidCreateUICall:"Memory is not empty. Please call createUI method once.",invalidInput:"You may send object, string, number, date, regexp or error as input but the following is not valid:",invalidNodeType:"Can not create a DOM element from the following input:",containerElemNotFound:"Couldn't render the app because the container DOM element (%s) you specified is not found in the DOM."},infoMsgs={creatingMem:"Creating memory.",componentsInit:"%s components initiated and added to memory."};function FrondJS(){StateManagerObject.call(this,{},{}),this.componentIDCounter=null,this.memory=[],this.debug=!1,this.initTime=null,this.settings=null,this.history=[],this.throttleScrollListener=null,this.viewers=[],this.networks=[]}FrondJS.prototype=Object.create(StateManagerObject.prototype),FrondJS.prototype.constructor=FrondJS,FrondJS.prototype.createUI=function(a,b=null){return this.initTime=Date.now(),this.settings={listenVisibilityChanges:this.utility.getProp(b,"listenVisibilityChanges",!0)},0<this.memory.length?void this.log("warning",errMsgs.invalidCreateUICall,this.memory):void(this.log("info",infoMsgs.creatingMem),this.memory=this.createMemory(a),this.log("info",infoMsgs.componentsInit,this.memory.length))},FrondJS.prototype.createMemory=function(a){function b(a,e,f){const g=c.utility.getProp(a,"id"),h=c.createComponent(a,e,f,g);if(!c.utility.isUndefined(h)){d.push(h);const a=c.getComponentChildren(h);if(c.utility.isArray(a)&&0<a.length)for(let c=0;c<a.length;c++)b(a[c],h,c)}}const c=this,d=[];return b(a,null,0),d},FrondJS.prototype.createComponent=function(a,b=null,c=0,d=null){const e=this,f=e.resolveComponentInput(a,b);if(e.utility.isUndefined(f))return void e.log("warning",errMsgs.invalidInput,a);const g=e.findComponentType(f),h=e.findComponentDOMNodeTag(g),i=e.findComponentDOMNodeType(g,h);if(!g||!i)return e.log("warning",errMsgs.invalidNodeType),void e.log("debug",f);const j=Object.assign({},e.utility.getProp(f,"state",{}),{_tick:!1}),k=e.createComponentInitialEventsFromInput(f,j),l=e.utility.getProp(f,"target");if(!e.utility.isEmpty(l)){e.utility.isEmpty(f.attrs)&&(f.attrs={});const a=e.getViewer().getLink(l);f.attrs.href=a||l}const m=new FrondComponent(j,k);m.index=c,m.parent=e.utility.getProp(b,"id",null),m.id=e.utility.isEmpty(d)?e.getNextComponentID():d,m.idAutoAssigned=e.utility.isEmpty(d),m.roots=[m.id].concat(e.utility.getProp(b,"roots",[])),m.input=f,m.type=g,m.domNodeTag=h,m.domNodeType=i;const n=e.utility.getProp(m.input,"analytics");m.analytics=!0===n,m.emit("init"),m.render(),m.emit("create");const o=e.utility.getProp(m.input,"viewer",null);return e.utility.isObject(o)&&!e.utility.isEmpty(o)&&e.registerComponentViewer(m,o),m},FrondJS.prototype.getComponentChildren=function(a){const b=this.utility.getProp(a.input,"render",null);if(this.utility.isFunction(b)){const c=b.apply(a,[]);return this.utility.isArray(c)?Array.from(c):this.utility.isNull(c)?null:[c]}return this.utility.isArray(b)?Array.from(b):this.utility.isNull(b)?null:[b]},FrondJS.prototype.render=function(a=null){const b=this;if(b.utility.isNull(a)){b.settings.listenVisibilityChanges&&(b.throttleScrollListener=b.utility.throttle(function(){b.memory.map(function(a){if(a.analytics){const b=a.dom.getBoundingClientRect(),{top:c,bottom:d}=b,e=window.innerHeight;0<=c&&d<=e?a.isFullyVisible():c<e&&0<=d?a.isPartiallyVisible():a.isHidden()}})},300),window.addEventListener("scroll",b.throttleScrollListener));const a=b.memory[0],c=document.getElementById(a.id);if(!b.utility.isDOMElement(c))return void b.log("warning",errMsgs.containerElemNotFound,a.id);b.mountChildren(a),a.dom.getAttribute("id")||a.dom.setAttribute("id",a.id),c.parentNode.replaceChild(a.dom,c),a.needsMount=!1,a.emit("mount"),b.history.push(b.memory),b.log("info","Initial rendering done in "+(Date.now()-b.initTime)+"ms.")}else a.render(),b.remountChildren(a)},FrondJS.prototype.mountChildren=function(a){const b=this.memory.filter(b=>b.parent==a.id&&b.shouldMount());if(this.utility.isArray(b)){const c=b.length;if(0!==b.length)for(let d=0;d<c;d++)a.dom.insertBefore(b[d].dom,null),b[d].shouldMount()&&(b[d].needsMount=!1,b[d].emit("mount")),this.mountChildren.apply(this,[b[d]])}},FrondJS.prototype.updateMemoryBlock=function(a){function b(a,e,f){let g=null;if(a instanceof FrondComponent)g=a;else{const b=c.utility.getProp(a,"id");g=c.createComponent(a,e,f,b)}if(!c.utility.isEmpty(g)){d.push(g);const a=c.getComponentChildren(g);if(c.utility.isArray(a)&&0<a.length)for(let c=0;c<a.length;c++)b(a[c],g,c)}}const c=this,d=[];return a.needsRemount=!0,a.render(),b(a,c.get(a.parent),a.index),d},FrondJS.prototype.mergeMemoryBlock=function(a){function b(h){const c=this.memory.filter(a=>a.parent==h.id),j=a.filter(a=>a.parent==h.id),k=d.isArray(c)?c.length:0,l=d.isArray(j)?j.length:0;if(k>l)for(let a=0;a<c.length;a++)a>=l&&e.push(c[a].id);if(this.utility.isArray(j)&&0<j.length)for(let a=0;a<j.length;a++){const d=k>a;if(d){const d=this.utility.getProp(c[a].input,"id"),h=this.utility.getProp(j[a].input,"id");this.utility.isString(h)&&d==h?(this.log("debug","Treated as same:",c[a],j[a]),g.push(h),b.apply(this,[j[a]])):(e.push(c[a].id),f.push(j[a]),b.apply(this,[j[a]]))}else f.push(j[a]),b.apply(this,[j[a]])}}const c=this,d=c.utility,e=[],f=[],g=[];b.apply(this,[a[0]]);const h=this.memory.filter(a=>!d.isEmpty(e.filter(b=>-1!==a.roots.indexOf(b)))).map(a=>a.id);if(this.removeComponents(h),this.appendComponents(f),0<g.length)for(let a=0;a<this.memory.length;a++)-1!==g.indexOf(this.memory[a].id)&&(this.memory[a].needsRemount=!0)},FrondJS.prototype.registerComponentViewer=function(a,b){const c=this;b.id=a.id;const d={initialShift:function(){const a=this;a.useAddressBar()&&window.addEventListener("popstate",function(){a.useAddressBar()&&a.shift(a.matchPath(window.location.pathname))})},afterShift:[function(){c.log("info","View changed to "+this.getActiveView().id),c.get(b.id).rerender(),window.scrollTo({top:0,behavior:"smooth"})}]};c.utility.isFunction(c.utility.getProp(b,["on","initialShift"]))&&d.initialShift.push(b.on.initialShift),c.utility.isFunction(c.utility.getProp(b,["on","afterShift"]))&&d.afterShift.push(b.on.afterShift),a.createViewer(d,b),c.viewers.push(a.id)},FrondJS.prototype.createComponentInitialEventsFromInput=function(a,b){const d=this,e=d.utility.getProp(a,"on",{});d.utility.isEqual({_tick:!1},b)||(!e.hasOwnProperty("afterUpdate")&&(e.afterUpdate=[]),!d.utility.isArray(e.afterUpdate)&&(e.afterUpdate=[e.afterUpdate]),e.afterUpdate.unshift(function(){const a=d.updateMemoryBlock(this);d.mergeMemoryBlock(a),d.render(this),d.history.push(d.memory)}));const f=d.utility.getProp(a,"target"),g=d.utility.getProp(a,["attrs","href"]);if(!d.utility.isEmpty(f)){const a=d.getViewer().getLink(f);e.hasOwnProperty("click")||(e.click=[]),d.utility.isArray(e.click)||(e.click=[e.click]),e.click.unshift(function(b){a&&(b.preventDefault(),d.getViewer().shift(f))})}const h=d.utility.getProp(a,"viewer",null);d.utility.isObject(h)&&!d.utility.isEmpty(h)&&(!e.hasOwnProperty("mount")&&(e.mount=[]),!d.utility.isArray(e.mount)&&(e.mount=[e.mount]),e.mount.unshift(function(){const a=this,b=a.getViewer().matchPath();setTimeout(function(){a.getViewer().shift(b.id)},1)}));const i=d.utility.getProp(a,"network",null);if(!d.utility.isEmpty(i)){let a=null,b=null;d.utility.isArray(i)?1===i.length?b=i[0]:2===i.length&&(a=i[0],b=i[1]):b=i,e.hasOwnProperty("mount")||(e.mount=[]),d.utility.isArray(e.mount)||(e.mount=[e.mount]),e.mount.unshift(function(){const e=this;setTimeout(function(){d.getNetwork(a).request(b,e)},1)})}return e},FrondJS.prototype.resolveComponentInput=function(a){const b=this.utility.getType(a);if(-1!==["string","number","object","date","regexp","error"].indexOf(b))switch(b){case"object":const c=this.utility.getProp(a,"viewer",null);if(this.utility.isObject(c)&&!this.utility.isEmpty(c)){if(this.utility.isEmpty(a.id))throw new Error("Viewer component must take an id.");a.state=Object.assign({},this.utility.getProp(a,"state",{}),{_viewer:!0}),a.render=viewerRenderFn}const d=this.utility.getProp(a,"network",null);return this.utility.isEmpty(d)||(a.state=Object.assign({},this.utility.getProp(a,"state",{}),{_data:null})),a;break;case"string":return a;break;case"number":case"regexp":return a.toString();break;case"date":return a.toISOString();break;case"error":return this.utility.stringifyError(a);break;default:}},FrondJS.prototype.findComponentType=function(a){const b=this.utility.getType(a);switch(b){case"string":case"number":return"plaintext";break;case"object":const c=this.utility.getProp(a,"type");if(c)return c;const d=this.utility.getProp(a,"target");return d?"link":"component";break;default:}},FrondJS.prototype.findComponentDOMNodeTag=function(a){return this.utility.isString(a)?frondTags.hasOwnProperty(a)?frondTags[a]:a:void 0},FrondJS.prototype.findComponentDOMNodeType=function(a,b){return"plaintext"==a?"plaintext":-1===htmlTags.indexOf(b)?-1===svgTags.indexOf(b)?void 0:"svg":"html"},FrondJS.prototype.getNextComponentID=function(){return this.utility.isNumber(this.componentIDCounter)||(this.componentIDCounter=0),this.componentIDCounter+=1,this.componentIDCounter.toString()},FrondJS.prototype.remountChildren=function(a){const b=this.memory.filter(b=>b.parent==a.id&&(b.shouldMount()||b.shouldRemount()));if(this.utility.isArray(b)){const c=b.length;if(0!==b.length)for(let d=0;d<c;d++){const c=a.dom.childNodes.length>b[d].index?a.dom.childNodes[b[d].index]:null;a.dom.insertBefore(b[d].dom,c),b[d].shouldMount()?(b[d].needsMount=!1,b[d].emit("mount")):b[d].shouldRemount()&&(b[d].needsRemount=!1,b[d].emit("remount")),this.remountChildren(b[d])}}},FrondJS.prototype.isSame=function(a,b){const c=a.id==b.id,d=!0===a.idAutoAssigned&&!0===b.idAutoAssigned;if(!d&&!c)return!1;const e=a.isStatic(),f=b.isStatic(),g=e&&f;if(g&&c)return!0;const h=a.getClassNames(),i=b.getClassNames(),j=this.utility.isEqual(h,i),k=a.getTextContent(),l=b.getTextContent(),m=this.utility.isEqual(k,l),n=a.domNodeTag==b.domNodeTag;if(g&&m&&n&&j)return!0;const o=this.utility.isEqual(a.getState(),b.getState());return!!(!e&&!f&&c&&o)},FrondJS.prototype.replaceComponents=function(a){if(!this.utility.isObject(a))return;const b=Object.keys(a);if(0!==b.length){const c=this.memory.length;for(let d=0;d<c;d++){const c=b.indexOf(this.memory[d].id);if(-1!==c){const e=b[c];this.memory[d].destroy(),this.memory[d]=a[e]}const e=b.indexOf(this.memory[d].parent);if(-1!==e){const c=b[e];this.memory[d].parent=a[c].id}const f=this.memory[d].roots.filter(a=>-1!==b.indexOf(a));f&&0<f.length&&(this.memory[d].roots=this.memory[d].roots.map(function(c){const d=b.indexOf(c);if(-1===d)return c;const e=b[d];return a[e].id}))}}},FrondJS.prototype.destroyComponents=function(a){if(!this.utility.isArray(a))return;if(0===a.length)return;const b=this.memory.filter(b=>-1!==a.indexOf(b.id)).sort(function(c,a){return c.roots.length>a.roots.length?-1:c.roots.length<a.roots.length?1:0}).map(a=>a.id),c=this.memory.length,d=[];for(let e=0;e<b.length;e++){const a=b[e];for(let b=0;b<c;b++)this.memory[b].id==a&&(this.memory[b].destroy(),d.push(b))}},FrondJS.prototype.removeComponents=function(a){if(!this.utility.isArray(a))return;if(0===a.length)return;const b=this.memory.filter(b=>-1!==a.indexOf(b.id)).sort(function(c,a){return c.roots.length>a.roots.length?-1:c.roots.length<a.roots.length?1:0}).map(a=>a.id),c=this.memory.length,d=[];for(let e=0;e<b.length;e++){const a=b[e];for(let b=0;b<c;b++)this.memory[b].id==a&&(this.memory[b].destroy(),d.push(b))}const e=d.sort(function(c,a){return c<a?-1:c>a?1:0});for(let b=e.length-1;0<=b;b--)this.memory.splice(e[b],1)},FrondJS.prototype.appendComponents=function(a=null){if(this.utility.isArray(a)&&0!==a.length)for(let b=0;b<a.length;b++)this.memory.push(a[b])},FrondJS.prototype.get=function(a){if(!this.utility.isEmpty(a)&&this.utility.isString(a)){const b=this.memory.length;for(let c=0;c<b;c++)if(this.memory[c].id==a)return this.memory[c]}},FrondJS.prototype.getViewer=function(a){const b=this.utility.isEmpty(a)?this.viewers[0]:a,c=this.get(b);return!!c&&c.getViewer()},FrondJS.prototype.createNetwork=function(a){const b={error:[function(){}]};b.hasOwnProperty("beforeFetch")||(b.beforeFetch=[]),b.beforeFetch.push(a.beforeFetch),b.hasOwnProperty("afterFetch")||(b.afterFetch=[]),b.afterFetch.push(a.afterFetch),this.networks.push(new Network(b,a))},FrondJS.prototype.getNetwork=function(a){if(this.utility.isEmpty(a))return this.networks[0];for(let b=0;b<this.networks.length;b++)if(this.networks[b].id==a)return this.networks[b]},FrondJS.prototype.ff=ff,FrondJS.prototype.log=function(a,b,c=[],...d){if("undefined"==typeof console)return;if(!this.debug)return;const e="warning"==a?"warn":"debug"==a?"warn":"info"==a?"info":"log",f=[],g=["[FrondJS]","["+a.toUpperCase()+"]",": "].join("");this.utility.isString(b)&&this.utility.isArray(c)?(b=this.utility.sprintf(b,c),f.push(g+b)):(this.utility.isString(b)?f.push(g+b):f.push(g,b),!this.utility.isEmpty(c)&&f.push(c),!this.utility.isEmpty(d)&&f.push.apply(f,d)),console.log.apply(console,f)},module.exports=FrondJS;